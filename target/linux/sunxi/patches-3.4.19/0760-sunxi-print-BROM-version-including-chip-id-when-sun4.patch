From 8981fef3226fd8171298af6bcaa2bb3d36d5946b Mon Sep 17 00:00:00 2001
From: Alejandro Mery <amery@geeks.cl>
Date: Wed, 19 Sep 2012 20:41:55 +0200
Subject: [PATCH 760/944] sunxi: print BROM version (including chip-id) when
 sun4i/sun5i boots

---
 arch/arm/mach-sun4i/core.c | 24 ++++++++++++++++++++++++
 arch/arm/mach-sun5i/core.c | 25 +++++++++++++++++++++++++
 2 files changed, 49 insertions(+)

diff --git a/arch/arm/mach-sun4i/core.c b/arch/arm/mach-sun4i/core.c
index e48b09e..a8f568f 100644
--- a/arch/arm/mach-sun4i/core.c
+++ b/arch/arm/mach-sun4i/core.c
@@ -72,9 +72,33 @@ static struct map_desc sw_io_desc[] __initdata = {
 	{ SW_VA_BROM_BASE, __phys_to_pfn(SW_PA_BROM_BASE),  (SZ_64K),           MT_MEMORY_ITCM  },
 };
 
+static void pr_brom(void *base)
+{
+	const struct {
+		u32 jump_instruction;	/* one intruction jumping to real code */
+		char magic[8];		/* ="eGON.BRM",  not C-style string. */
+		u32 length;		/* generated by PC */
+		char Boot_vsn[4];	/* Boot version */
+		char eGON_vsn[4];	/* eGON version */
+		char platform[8];	/* platform information */
+	} *brom = base + 0x4000;
+
+	/* [    0.000000] BROM Ver: 1100 1100 1623 */
+	if (strncmp(brom->magic, "eGON.BRM", 8) == 0) {
+		pr_info("BROM Ver: %.4s %.4s %.8s\n",
+			brom->Boot_vsn,
+			brom->eGON_vsn,
+			brom->platform);
+	} else {
+		pr_err("SUNXI BROM not found");
+	}
+}
+
 void __init sw_core_map_io(void)
 {
 	iotable_init(sw_io_desc, ARRAY_SIZE(sw_io_desc));
+
+	pr_brom((void*)SW_VA_BROM_BASE);
 }
 
 #ifdef CONFIG_SUNXI_IGNORE_ATAG_MEM
diff --git a/arch/arm/mach-sun5i/core.c b/arch/arm/mach-sun5i/core.c
index b4e0a67..24faf6c 100644
--- a/arch/arm/mach-sun5i/core.c
+++ b/arch/arm/mach-sun5i/core.c
@@ -70,11 +70,36 @@
 static struct map_desc sw_io_desc[] __initdata = {
 	{ SW_VA_SRAM_BASE, __phys_to_pfn(SW_PA_SRAM_BASE),  (SZ_128K + SZ_64K), MT_MEMORY_ITCM  },
 	{ SW_VA_IO_BASE,   __phys_to_pfn(SW_PA_IO_BASE),    (SZ_1M + SZ_2M),    MT_DEVICE    },
+	{ SW_VA_BROM_BASE, __phys_to_pfn(SW_PA_BROM_BASE),  (SZ_64K),           MT_MEMORY_ITCM  },
 };
 
+static void pr_brom(void *base)
+{
+	const struct {
+		u32 jump_instruction;	/* one intruction jumping to real code */
+		char magic[8];		/* ="eGON.BRM",  not C-style string. */
+		u32 length;		/* generated by PC */
+		char Boot_vsn[4];	/* Boot version */
+		char eGON_vsn[4];	/* eGON version */
+		char platform[8];	/* platform information */
+	} *brom = base + 0x4000;
+
+	/* [    0.000000] BROM Ver: 1100 1100 1625 */
+	if (strncmp(brom->magic, "eGON.BRM", 8) == 0) {
+		pr_info("BROM Ver: %.4s %.4s %.8s\n",
+			brom->Boot_vsn,
+			brom->eGON_vsn,
+			brom->platform);
+	} else {
+		pr_err("SUNXI BROM not found");
+	}
+}
+
 void __init sw_core_map_io(void)
 {
 	iotable_init(sw_io_desc, ARRAY_SIZE(sw_io_desc));
+
+	pr_brom((void*)SW_VA_BROM_BASE);
 }
 
 static u32 DRAMC_get_dram_size(void)
-- 
1.8.0

